# # Explanation about `glyenzy_enzymes.json`
#
# ## Format
#
# - "name": gene symbol of the enzyme
# - "rules": a list of rules, each rule is a dictionary with the following keys:
#     - "acceptor": the motif recognized by the enzyme
#     - "acceptor_alignment": alignment of the acceptor motif
#     - "rejects": a list of motifs to be rejected
#     - "rejects_alignment": alignment of the rejects
#     - "product": the product generated by the enzyme,
#       should be exactly one residue longer than the acceptor
# - "type": "GT" for glycosyltransferase or "GH" for glycoside hydrolase
# - "species": species of the enzyme
devtools::load_all()

# Load required packages
library(jsonlite)
library(purrr)

# Read JSON data
json_data <- jsonlite::fromJSON("data-raw/glyenzy_enzymes.json")

# Helper function to create enzyme rule from JSON data
.create_enzyme_rule_from_json <- function(rule_data, enzyme_type) {
  # Handle null acceptor (for DPAGT1)
  if (is.null(rule_data$acceptor) || is.na(rule_data$acceptor)) {
    acceptor <- NULL
    acceptor_alignment <- NULL
  } else {
    acceptor <- glyparse::parse_iupac_condensed(rule_data$acceptor)
    acceptor_alignment <- rule_data$acceptor_alignment
  }

  product <- glyparse::parse_iupac_condensed(rule_data$product)

  # Handle rejects - they are stored as lists in JSON
  rejects_list <- rule_data$rejects[[1]]  # Extract the list content
  rejects_alignment_list <- rule_data$rejects_alignment[[1]]  # Extract the list content

  if (length(rejects_list) == 0) {
    rejects <- glyparse::parse_iupac_condensed(character(0))
    rejects_alignment <- character(0)
  } else {
    rejects <- glyparse::parse_iupac_condensed(rejects_list)
    rejects_alignment <- rejects_alignment_list
  }

  glyenzy:::new_enzyme_rule(acceptor, product, acceptor_alignment, rejects, rejects_alignment)
}

# Helper function to create enzyme from JSON data (for data.frame row)
.create_enzyme_from_json <- function(i, json_data) {
  name <- json_data$name[i]
  type <- json_data$type[i]
  species <- json_data$species[i]

  # Create rules
  rules_data <- json_data$rules[[i]]
  rules <- purrr::map(seq_len(nrow(rules_data)), function(j) {
    .create_enzyme_rule_from_json(rules_data[j, ], enzyme_type = type)
  })
  # Remove NULL rules (those with NA values)
  rules <- purrr::compact(rules)

  # Create and validate enzyme, and enhance it
  enzyme <- glyenzy:::new_enzyme(name, rules, type, species)
  glyenzy:::validate_enzyme(enzyme)
  enzyme <- glyenzy:::enhance_enzyme(enzyme)

  enzyme
}

# Create list of enzymes
glyenzy_enzymes <- purrr::map(seq_len(nrow(json_data)), .create_enzyme_from_json, json_data = json_data)

# Set names to gene symbols
names(glyenzy_enzymes) <- json_data$name

# Save the data
usethis::use_data(glyenzy_enzymes, overwrite = TRUE, internal = TRUE)
