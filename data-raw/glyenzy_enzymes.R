# # Explanation about `glyenzy_enzymes.json`
#
# ## Format
#
# - "name": gene symbol of the enzyme
# - "rules": a list of rules, each rule is a dictionary with the following keys:
#     - "acceptor": the motif recognized by the enzyme
#     - "acceptor_alignment": alignment of the acceptor motif
#     - "product": the product generated by the enzyme,
#       should be exactly one residue longer than the acceptor
# - "rejects": a list of exceptions to "acceptor",
#   each exception is a dictionary with the following keys:
#     - "motif": the motif to be rejected
#     - "alignment": alignment of the motif
# - "markers": a list of motifs that indicate the enzyme is involved in the biosynthesis of a glycan,
#   each marker is a dictionary with the following keys:
#     - "motif": the marker motif
#     - "alignment": alignment of the marker
# - "type": "GT" for glycosyltransferase or "GD" for exoglycosidase
# - "species": species of the enzyme
#
# ## Additional Notes
#
# ### Rules about the ALG family
#
# These enzymes involve in the synthesis of the dolichol-linked precursor.
# The oligosaccharide part is linked to P-P-Dolichol throught a-linkage.
# However, when the whole glycan is transfered to Asn, the linkage becomes b-linkage.
# Therefore, although these enzymes actually recognize motifs with a-reducing-ends,
# we use "b" as the reducing-end in the acceptor and product.
#
# ### ALG markers
#
# All N-glycans observed on Asn must have been processed by all ALG family.
# So the "marker" field for these enzymes is just the N-glycan core.

devtools::load_all()

# Load required packages
library(jsonlite)
library(purrr)

# Read JSON data
json_data <- jsonlite::fromJSON("data-raw/glyenzy_enzymes.json")

# Helper function to create motif set from JSON data
.create_motif_set_from_json <- function(motif_data) {
  if (nrow(motif_data) == 0) {
    # Create empty motif set
    motifs <- glyparse::parse_iupac_condensed(character(0))
    alignments <- character(0)
  } else {
    # motif_data should be a data.frame with motif and alignment columns
    motifs <- glyparse::parse_iupac_condensed(motif_data$motif)
    alignments <- motif_data$alignment
  }

  glyenzy:::new_motif_set(motifs, alignments)
}

# Helper function to create enzyme rule from JSON data
.create_enzyme_rule_from_json <- function(rule_data, enzyme_type) {
  # Skip rules with NA values
  if (is.na(rule_data$acceptor) || is.na(rule_data$product)) {
    return(NULL)
  }

  acceptor <- glyparse::parse_iupac_condensed(rule_data$acceptor)
  product <- glyparse::parse_iupac_condensed(rule_data$product)
  acceptor_alignment <- rule_data$acceptor_alignment

  glyenzy:::new_enzyme_rule(acceptor, product, acceptor_alignment, enzyme_type)
}

# Helper function to create enzyme from JSON data (for data.frame row)
.create_enzyme_from_json <- function(i, json_data) {
  name <- json_data$name[i]
  type <- json_data$type[i]
  species <- json_data$species[i]

  # Create rules
  rules_data <- json_data$rules[[i]]
  rules <- purrr::map(seq_len(nrow(rules_data)), function(j) {
    .create_enzyme_rule_from_json(rules_data[j, ], enzyme_type = type)
  })
  # Remove NULL rules (those with NA values)
  rules <- purrr::compact(rules)

  # Create rejects motif set
  rejects_data <- json_data$rejects[[i]]
  rejects <- .create_motif_set_from_json(rejects_data)

  # Create markers motif set
  markers_data <- json_data$markers[[i]]
  markers <- .create_motif_set_from_json(markers_data)

  # Create and validate enzyme
  enzyme <- glyenzy:::new_enzyme(name, rules, rejects, markers, type, species)
  glyenzy:::validate_enzyme(enzyme)

  enzyme
}

# Create list of enzymes
glyenzy_enzymes <- purrr::map(seq_len(nrow(json_data)), .create_enzyme_from_json, json_data = json_data)

# Set names to gene symbols
names(glyenzy_enzymes) <- json_data$name

# Save the data
usethis::use_data(glyenzy_enzymes, overwrite = TRUE)
